<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>  Parallelizing Rsync | Nairobi GNU/Linux Users Group
</title>
  <link rel="canonical" href="/2014/07/parallelizing-rsync.html">

    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#333333">

  <link rel="stylesheet" href="/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="/theme/css/pygments/monokai.min.css">
  <link rel="stylesheet" href="/theme/css/theme.css">

  
  <meta name="description" content="Using find and xargs to parallelize rsync and speed up transfers of large directory hierarchies">


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
    <div class="col-sm-4">
      <a href="/">
        <img class="img-fluid rounded" src=/images/profile.png alt="Nairobi GNU/Linux Users Group">
      </a>
    </div>
  <div class="col-sm-8">
    <h1 class="title"><a href="/">Nairobi GNU/Linux Users Group</a></h1>
      <p class="text-muted">A lively community of GNU/Linux enthusiasts</p>
      <ul class="list-inline">
          <li class="list-inline-item"><a href="https://web.libera.chat/?channels=#nairobilug" target="_blank">IRC</a></li>
              <li class="list-inline-item text-muted">|</li>
            <li class="list-inline-item"><a href="/pages/about-us.html">About Us</a></li>
            <li class="list-inline-item"><a href="/pages/code-of-conduct.html">Code of Conduct</a></li>
            <li class="list-inline-item"><a href="/pages/contact.html">Contact</a></li>
            <li class="list-inline-item"><a href="/pages/mailing-list.html">Mailing List</a></li>
            <li class="list-inline-item"><a href="/pages/meetups.html">Meetups</a></li>
            <li class="list-inline-item"><a href="/pages/software.html">Software</a></li>
            <li class=" list-inline-item text-muted">|</li>
          <li class="list-inline-item"><a class="fa fa-github" href="https://github.com/nairobilug" target="_blank"></a></li>
          <li class="list-inline-item"><a class="fa fa-twitter" href="https://twitter.com/nairobilug" target="_blank"></a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  Parallelizing Rsync
</h1>
      <hr>
  <article class="article">
    <header>
      <ul class="list-inline">
        <li class="list-inline-item text-muted" title="2014-07-11T16:40:00+03:00">
          <i class="fa fa-clock-o"></i>
          Fri 11 July 2014
        </li>
        <li class="list-inline-item">
          <i class="fa fa-folder-open-o"></i>
          <a href="/category/linux.html">Linux</a>
        </li>
          <li class="list-inline-item">
            <i class="fa fa-user-o"></i>
              <a href="/author/alan-orth.html">Alan Orth</a>          </li>
          <li class="list-inline-item">
            <i class="fa fa-files-o"></i>
              <a href="/tag/linux.html">#linux</a>,               <a href="/tag/rsync.html">#rsync</a>          </li>
      </ul>
    </header>
    <div class="content">
      <p>Last week I had a massive hardware failure on one of the GlusterFS storage nodes in the <a href="http://hpc.ilri.cgiar.org/">ILRI, Kenya Research Computing cluster</a>; two drives failed simultaneously on the underlying RAID5. As RAID5 can only withstand one drive failure, the entire 31TB array was toast. FML.</p>
<p>After replacing the failed disks, rebuilding the array, and formatting my bricks, I decided I would use <code>rsync</code> to pre-seed my bricks from the good node before bringing <code>glusterd</code> back up.</p>
<p><em>tl;dr</em>: <code>rsync</code> is amazing, but it’s single threaded and struggles when you tell it to sync large directory hierarchies. <a href="#sync_bricks">Here's how you can speed it up</a>.</p>
<h3>rsync #fail</h3>
<p>I figured syncing the brick hierarchy from the good node to the bad node was simple enough, so I stopped the <code>glusterd</code> service on the bad node and invoked:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>rsync<span class="w"> </span>-aAXv<span class="w"> </span>--delete<span class="w"> </span>--exclude<span class="o">=</span>.glusterfs<span class="w"> </span>storage0:/path/to/bricks/homes/<span class="w"> </span>storage1:/path/to/bricks/homes/
</code></pre></div>
<p>After a day or so I noticed I had only copied ~1.5TB (over 1 hop on a dedicated 10GbE switch!), and I realized something must be wrong. I attached to the <code>rsync</code> process with <code>strace -p</code> and saw a bunch of system calls in one particular user’s directory. I dug deeper:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>find<span class="w"> </span>/path/to/bricks/homes/ukenyatta/maker/genN_datastore/<span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
<span class="go">1398640</span>
</code></pre></div>
<p>So this one particular directory in one user's home contained over a million <em>other</em> directories and $god knows how many files, and this command itself took several hours to finish! To make matters worse, careful trial and error inspection of other user home directories revealed more massive directory structures as well.</p>
<ul>
<li>rsync is single threaded</li>
<li>rsync generates a list of files to be synced before it starts the sync</li>
<li>MAKER creates a ton of output files/directories</li>
</ul>
<p>It's pretty clear (now) that a recursive <code>rsync</code> on my huge directory hierarchy is out of the question!</p>
<h3>rsync #win</h3>
<p>I had a look around and saw lots of people complaining about <code>rsync</code> being "slow" and others suggesting tips to speed it up. One very promising strategy was described on <a href="https://wiki.ncsa.illinois.edu/display/~wglick/Parallel+Rsync">this wiki</a> and there's a great discussion in the comments.</p>
<p>Basically, he describes a clever use of <code>find</code> and <code>xargs</code> to split up the problem set into smaller pieces that <code>rsync</code> can process more quickly.</p>
<h3>sync_brick.sh</h3>
<p>So here's my adaptation of his script for the purpose of syncing failed GlusterFS bricks, <code>sync_brick.sh</code>:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/env bash</span>
<span class="c1"># borrowed / adapted from: https://wiki.ncsa.illinois.edu/display/~wglick/Parallel+Rsync</span>

<span class="c1"># RSYNC SETUP</span>
<span class="nv">RSYNC_PROG</span><span class="o">=</span>/usr/bin/rsync
<span class="c1"># note the important use of --relative to use relative paths so we don't have to specify the exact path on dest</span>
<span class="nv">RSYNC_OPTS</span><span class="o">=</span><span class="s2">"-aAXv --numeric-ids --progress --human-readable --delete --exclude=.glusterfs --relative"</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">RSYNC_RSH</span><span class="o">=</span><span class="s2">"ssh -T -c arcfour -o Compression=no -x"</span>

<span class="c1"># ENV SETUP</span>
<span class="nv">SRCDIR</span><span class="o">=</span>/path/to/good/brick
<span class="nv">DESTDIR</span><span class="o">=</span>/path/to/bad/brick
<span class="c1"># Recommend to match # of CPUs</span>
<span class="nv">THREADS</span><span class="o">=</span><span class="m">4</span>
<span class="nv">BAD_NODE</span><span class="o">=</span>server1

<span class="nb">cd</span><span class="w"> </span><span class="nv">$SRCDIR</span>

<span class="c1"># COPY</span>
<span class="c1"># note the combination of -print0 and -0!</span>
find<span class="w"> </span><span class="o">{</span>a..z<span class="o">}</span>*<span class="w"> </span><span class="o">{</span>A..Z<span class="o">}</span>*<span class="w"> </span><span class="o">{</span><span class="m">0</span>..9<span class="o">}</span>*<span class="w"> </span>-mindepth<span class="w"> </span><span class="m">1</span><span class="w"> </span>-maxdepth<span class="w"> </span><span class="m">1</span><span class="w"> </span>-print0<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>xargs<span class="w"> </span>-0<span class="w"> </span>-n1<span class="w"> </span>-P<span class="nv">$THREADS</span><span class="w"> </span>-I%<span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="nv">$RSYNC_PROG</span><span class="w"> </span><span class="nv">$RSYNC_OPTS</span><span class="w"> </span><span class="s2">"%"</span><span class="w"> </span><span class="nv">$BAD_NODE</span>:<span class="nv">$DESTDIR</span>
</code></pre></div>
<p>Pay attention to the source/destination paths, the number of <code>THREADS</code>, and the <code>BAD_NODE</code> name, then you should be ready to roll.</p>
<h3>The Magic, Explained</h3>
<p>It's a bit of magic, but here are the important parts:</p>
<ul>
<li>The <code>-aAXv</code> options to <code>rsync</code> tell it to <strong>archive</strong>, preserve <strong>ACLs</strong>, and preserve <strong>eXtended</strong> attributes. Extended attributes are <a href="http://joejulian.name/blog/what-is-this-new-glusterfs-directory-in-33">critically important in GlusterFS &gt;= 3.3</a>, and also if you're using SELinux.</li>
<li>The <code>--exclude=.glusterfs</code> option to <code>rsync</code> tells it to ignore this directory at the root of the directory, as the self-heal daemon — <code>glustershd</code> — will rebuild it based on the files' extended attributes once we restart the <code>glusterd</code> service.</li>
<li>The <code>--relative</code> option to <code>rsync</code> is so we don't have to bother constructing the destination path, as <code>rsync</code> will imply the path is relative to our destination's top.</li>
<li>The <code>RSYNC_RSH</code> options influence <code>rsync</code>'s use of SSH, basically telling it to use very weak encryption and disable any unnecessary features for non-interactive sessions (tty, X11, etc).</li>
<li>Using <code>find</code> with <code>-mindepth 1</code> and <code>-maxdepth 1</code> just means we concentrate on files/directories 1 level below each directory in our immediate hierarchy.</li>
<li>Using <code>xargs</code> with <code>-n1</code> and <code>-P</code> tells it to use 1 argument per command line, and to launch <code>$THREADS</code> number of processes at a time.</li>
</ul>
<p>Hope this helps!</p>
<p>This was <a href="https://mjanja.ch/2014/07/parallelizing-rsync/">originally posted</a> on my personal blog; re-posted here for posterity.</p>
    </div>
  </article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
      <li class="list-inline-item"><a href="/authors.html">Authors</a></li>
    <li class="list-inline-item"><a href="/archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="/categories.html">Categories</a></li>
      <li class="list-inline-item"><a href="/tags.html">Tags</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
  </p>
</div>    </div>
  </footer>
</body>

</html>