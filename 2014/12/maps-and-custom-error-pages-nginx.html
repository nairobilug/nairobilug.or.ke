<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>  Nairobi LUG &mdash; Maps and custom error pages in nginx
</title>

      <link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
      <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
      <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
      <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">


      <link type="application/atom+xml" rel="alternate" href="/feed/atom.xml"  title="Nairobi LUG Atom Feed">

    <link rel="stylesheet" href="http://nairobilug.or.ke/theme/css/style.css">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-730843-9', 'nairobilug.or.ke');
    ga('send', 'pageview');
  </script>

    <meta name="author" content="Alan Orth">
    <meta name="description" content="Using nginx maps to allow IP ranges during web server maintenance">
  <meta name="tags" contents="linux, nginx, ">
</head>

<body>
<header class="header">
  <div class="container">
      <div class="header-image pull-left">
        <a class="nodec" href="http://nairobilug.or.ke"><img src=/images/profile.svg width="200" height="200"></a>
      </div>
    <div class="header-inner">
      <h1 class="header-name">
        <a class="nodec" href="http://nairobilug.or.ke">Nairobi LUG</a>
      </h1>
      <h3 class="header-text">Nairobi GNU/Linux Users Group</h3>
      <ul class="header-menu list-inline">
          <li><a class="nodec" href="https://kiwiirc.com/client/irc.freenode.net/#nairobilug" target="_blank">IRC</a></li>
          <li><a class="nodec" href="https://groups.google.com/forum/#!forum/nairobi-gnu" target="_blank">Mailing List</a></li>
              <li class="muted">|</li>
            <li><a class="nodec" href="http://nairobilug.or.ke/2013/10/pages/about-us.html">About Us</a></li>
              <li class="muted">|</li>
          <li><a class="nodec icon-github" href="https://github.com/nairobilug"></a></li>
          <li><a class="nodec icon-twitter" href="https://twitter.com/nairobilug"></a></li>
          <li><a class="nodec icon-rss" href="/feed/atom.xml"></a></li>
      </ul>
    </div>
  </div>
</header> <!-- /.header -->  <div class="container">
  <div class="post full-post">
    <h1 class="post-title">
      <a href="/2014/12/maps-and-custom-error-pages-nginx.html" title="Permalink to Maps and custom error pages in nginx">Maps and custom error pages in nginx</a>
    </h1>
    <ul class="list-inline">
      <li class="post-date">
        <a class="text-muted" href="/2014/12/maps-and-custom-error-pages-nginx.html" title="2014-12-09T17:00:00+03:00">Tue 09 December 2014</a>
      </li>
      <li class="muted">&middot;</li>
      <li class="post-category">
        <a href="http://nairobilug.or.ke/category/linux.html">Linux</a>
      </li>
        <li class="muted">&middot;</li>
        <li>
          <address class="post-author">
            By <a href="http://nairobilug.or.ke/author/alan-orth.html">Alan Orth</a>
          </address>
        </li>
    </ul>
    <div class="post-content">
      <p>During a recent web application upgrade I had to limit access to the the web servers; I wanted the administrators and myself to be able to access the site, but for everyone else to see an "<em>Under Construction</em>" page. My initial plan was to test if the <code>$remote_addr</code> was one of the allowed IPs, and then redirect those clients to a maintenance page, but I couldn't figure out how to test more than one IP address (seriously)!</p>
<p>I eventually stumbled upon the <a href="http://nginx.org/en/docs/http/ngx_http_map_module.html">nginx map module</a> which, combined with a custom error page, ended up being an elegant, fun solution to this problem.</p>
<h3>Elegant maps</h3>
<p>Here is a snippet from <em>/etc/nginx/conf.d/default.conf</em> which shows the important bits:</p>
<div class="highlight"><pre><span class="nt">server</span> <span class="p">{</span>
<span class="o">...</span>

    <span class="n">location</span> <span class="o">/</span> <span class="err">{</span>
        <span class="n">if</span> <span class="p">(</span><span class="err">$</span><span class="n">denied</span> <span class="o">!=</span> <span class="m">0</span><span class="p">)</span> <span class="err">{</span>
            <span class="err">#</span> <span class="n">HTTP</span> <span class="m">503</span><span class="o">:</span> <span class="n">service</span> <span class="n">unavailable</span>
            <span class="n">return</span> <span class="m">503</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="err">#</span> <span class="nt">Send</span> <span class="nt">requests</span> <span class="nt">to</span> <span class="nt">Tomcat</span>
         <span class="nt">proxy_pass</span> <span class="nt">http</span><span class="o">://</span><span class="nt">127</span><span class="nc">.0.0.1</span><span class="nd">:8443</span><span class="o">;</span>
    <span class="err">}</span>

    <span class="nt">error_page</span> <span class="nt">503</span> <span class="k">@maintenance</span><span class="p">;</span>

    <span class="nt">location</span> <span class="k">@maintenance</span> <span class="p">{</span>
        <span class="nt">root</span> <span class="o">/</span><span class="nt">tmp</span><span class="o">;</span>
        <span class="nt">rewrite</span> <span class="o">^(.*)$</span> <span class="o">/</span><span class="nt">maintenance</span><span class="nc">.html</span> <span class="nt">break</span><span class="o">;</span>
    <span class="p">}</span>
<span class="err">}</span>

<span class="nt">map</span> <span class="o">$</span><span class="nt">remote_addr</span> <span class="o">$</span><span class="nt">denied</span> <span class="p">{</span>
    <span class="k">default</span> <span class="m">1</span><span class="p">;</span>
    <span class="m">2</span><span class="o">.</span><span class="m">18</span><span class="o">.</span><span class="m">216</span><span class="o">.</span><span class="m">110</span> <span class="m">0</span><span class="p">;</span>
    <span class="m">192</span><span class="o">.</span><span class="m">64</span><span class="o">.</span><span class="m">147</span><span class="o">.</span><span class="m">150</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>By default all IP addresses are denied (ie, <code>$denied=1</code>), but depending on the client's IP address, the <code>$denied</code> variable can be set to 0. In the root location block I essentially test if the IP address is denied and conditionally return an HTTP 503 (<em>Service Unavailable</em>), which is handled by a custom <code>error_page</code> handler with a named location block. So cool!</p>
<h3>In retrospect</h3>
<p>In retrospect I probably could have used a regex in the <code>$remote_addr</code> test, but maps are really a more flexible, efficient, and "nginx" way of accomplishing this. On that note, I'm using nginx more and more lately and, in addition to being fast as hell and having better TLS support, it's just more fun to use than Apache. ;)</p>
<p>Furthermore, to deploy this I wrote an Ansible playbook which included a list of allowed IPs and reconfigured the nginx vhost by using a Jinja2 template which iterated over the IPs to create the map block above. Very cool, and very easy to reverse when the maintenance was over!</p>
<p>This was originally <a href="https://mjanja.ch/2014/12/maps-and-custom-error-pages-in-nginx/">posted on</a> on my personal blog; re-posted here for posterity.</p>
    </div>
  </div>
  <hr class="separator">
  <div class="col-md-8 col-md-offset-2">
  <div id="disqus_thread">
    <script>
      var disqus_shortname = 'nairobilug';
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] ||
         document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>
      Please enable JavaScript to view the
      <a href="http://disqus.com/?ref_noscript=nairobilug">
        comments powered by Disqus.
      </a>
    </noscript>
    <a href="http://disqus.com" class="dsq-brlink">
      blog comments powered by <span class="logo-disqus">Disqus</span>
    </a>
  </div>
  </div>
  </div>
<footer class="footer">
  <div class="container">
    <p class="text-center">
      Multiple, <a href="" target="_blank"></a> unless otherwise noted.
    </p>
    <div class="text-center">
      Generated by <a href="http://getpelican.com" target="_blank">Pelican</a> with the <a href="http://github.com/nairobilug/pelican-alchemy">alchemy</a> theme.
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="http://nairobilug.or.ke/theme/js/jquery.min.js"></script>
  <script src="http://nairobilug.or.ke/theme/js/bootstrap.min.js"></script>
</body> <!-- 42 -->

</html>