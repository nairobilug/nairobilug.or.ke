<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>  Safely Rotating MySQL Slow Query Logs | Nairobi GNU/Linux Users Group
</title>
  <link rel="canonical" href="/2016/04/safely-rotating-mysql-slow-logs.html">

    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#333333">

  <link rel="stylesheet" href="/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="/theme/css/pygments/monokai.min.css">
  <link rel="stylesheet" href="/theme/css/theme.css">

  
  <meta name="description" content="Recommended way of rotating MySQL slow query logs.">


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
    <div class="col-sm-4">
      <a href="/">
        <img class="img-fluid rounded" src=/images/profile.png alt="Nairobi GNU/Linux Users Group">
      </a>
    </div>
  <div class="col-sm-8">
    <h1 class="title"><a href="/">Nairobi GNU/Linux Users Group</a></h1>
      <p class="text-muted">A lively community of GNU/Linux enthusiasts</p>
      <ul class="list-inline">
          <li class="list-inline-item"><a href="https://web.libera.chat/?channels=#nairobilug" target="_blank">IRC</a></li>
              <li class="list-inline-item text-muted">|</li>
            <li class="list-inline-item"><a href="/pages/about-us.html">About Us</a></li>
            <li class="list-inline-item"><a href="/pages/contact.html">Contact</a></li>
            <li class="list-inline-item"><a href="/pages/mailing-list.html">Mailing List</a></li>
            <li class="list-inline-item"><a href="/pages/meetups.html">Meetups</a></li>
            <li class="list-inline-item"><a href="/pages/software.html">Software</a></li>
            <li class=" list-inline-item text-muted">|</li>
          <li class="list-inline-item"><a class="fa fa-github" href="https://github.com/nairobilug" target="_blank"></a></li>
          <li class="list-inline-item"><a class="fa fa-twitter" href="https://twitter.com/nairobilug" target="_blank"></a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  Safely Rotating MySQL Slow Query Logs
</h1>
      <hr>
  <article class="article">
    <header>
      <ul class="list-inline">
        <li class="list-inline-item text-muted" title="2016-04-16T16:05:00+03:00">
          <i class="fa fa-clock-o"></i>
          Sat 16 April 2016
        </li>
        <li class="list-inline-item">
          <i class="fa fa-folder-open-o"></i>
          <a href="/category/linux.html">Linux</a>
        </li>
          <li class="list-inline-item">
            <i class="fa fa-user-o"></i>
              <a href="/author/james-oguya.html">James Oguya</a>          </li>
          <li class="list-inline-item">
            <i class="fa fa-files-o"></i>
              <a href="/tag/mysql.html">#mysql</a>,               <a href="/tag/mariadb.html">#mariadb</a>          </li>
      </ul>
    </header>
    <div class="content">
      <p>MySQL slow query log consists of SQL statements that took more than <a href="https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_long_query_time">long_query_time</a> seconds to complete execution &amp; required atleast <a href="https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_min_examined_row_limit">min_examined_row_limit</a> to be examined. By default, administrative queries &amp; those that don't use indexes for lookups are not logged.</p>
<p>Two common techniques used by <a href="http://linux.die.net/man/8/logrotate">Logrotate</a> are:</p>
<ul>
<li><strong>copytruncate</strong>: Instead of moving the old log file &amp; optionally creating a new one, logrotate truncates the original log file in place after creating a copy.</li>
<li><strong>nocopytruncate</strong>: Do not truncate the original log file in place after creating a copy.</li>
</ul>
<p>Truncating log files can block MySQL because the OS serializes access to the inode during the truncate operation. Therefore, it is recommended to temporarily stop slow query logging, flush slow logs, rename the old log file &amp; finally re-enable slow query logging.</p>
<p>Flushing logs might take a considerable amount of time, so, to avoid filling slow log buffer, it's advisable to temporarily disable MySQL slow query logging &amp; re-enabling it once the rotation is complete.</p>
<h2>Manual Rotation</h2>
<p>To manually rotate slow query logs, we'll temporarily disable slow query logging, flush slow logs, rename the original file &amp; finally re-enable slow query logging.</p>
<ul>
<li>
<p>get the path to slow query log file</p>
<div class="highlight"><pre><span></span><code><span class="c">MariaDB </span><span class="k">[</span><span class="c">(none)</span><span class="k">]</span><span class="nv">&gt;</span><span class="c"> show variables like '%slow_query%';</span>
<span class="nb">+---------------------+-------------------------------+</span><span class="c"></span>
<span class="c">| Variable_name       | Value                         |</span>
<span class="nb">+---------------------+-------------------------------+</span><span class="c"></span>
<span class="c">| slow_query_log      | ON                            |</span>
<span class="c">| slow_query_log_file | /var/lib/mysql/mysql</span><span class="nb">-</span><span class="c">slow</span><span class="nt">.</span><span class="c">log |</span>
<span class="nb">+---------------------+-------------------------------+</span><span class="c"></span>
<span class="c">2 rows in set (0</span><span class="nt">.</span><span class="c">00 sec)</span>
</code></pre></div>
</li>
<li>
<p>temporarily disable slow query logging</p>
<div class="highlight"><pre><span></span><code>MariaDB [(none)]&gt; set global slow_query_log=off;
Query OK, 0 rows affected (0.00 sec)
</code></pre></div>
</li>
<li>
<p>flush only slow logs</p>
<div class="highlight"><pre><span></span><code>MariaDB [(none)]&gt; flush slow logs;
Query OK, 0 rows affected (0.00 sec)
</code></pre></div>
</li>
<li>
<p>rename the old log file and or compress it</p>
<div class="highlight"><pre><span></span><code><span class="c1"># mv /var/lib/mysql/mysql-slow.log /var/lib/mysql/mysql-slow-$(date +%Y-%m-%d).log</span><span class="w"></span>
<span class="c1"># gzip -c /var/lib/mysql/mysql-slow-$(date +%Y-%m-%d).log &gt; /var/lib/mysql/mysql-slow-$(date +%Y-%m-%d).log.gz</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>finally, re-enable slow query logging</p>
<div class="highlight"><pre><span></span><code>MariaDB [(none)]&gt; set global slow_query_log=on;
Query OK, 0 rows affected (0.00 sec)
</code></pre></div>
</li>
</ul>
<h2>Using Logrotate</h2>
<p>Instead of manual rotation, you can use a lograte config file to acheive the same effect by using logrotate: <code>/etc/logrotate.d/mysql-slow-logs</code></p>
<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">slow</span><span class="o">.</span><span class="n">log</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="mi">1</span><span class="n">G</span><span class="w"></span>
<span class="w">    </span><span class="n">dateext</span><span class="w"></span>
<span class="w">    </span><span class="n">compress</span><span class="w"></span>
<span class="w">    </span><span class="n">missingok</span><span class="w"></span>
<span class="w">    </span><span class="n">rotate</span><span class="w"> </span><span class="mi">20</span><span class="w"></span>
<span class="w">    </span><span class="n">notifempty</span><span class="w"></span>
<span class="w">    </span><span class="n">delaycompress</span><span class="w"></span>
<span class="w">    </span><span class="n">sharedscripts</span><span class="w"></span>
<span class="w">    </span><span class="n">nocopytruncate</span><span class="w"></span>
<span class="w">    </span><span class="n">create</span><span class="w"> </span><span class="mi">660</span><span class="w"> </span><span class="n">mysql</span><span class="w"> </span><span class="n">mysql</span><span class="w"></span>
<span class="w">    </span><span class="n">postrotate</span><span class="w"></span>
<span class="w">        </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">mysql</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="s1">'select @@global.slow_query_log into @sq_log_save; set global slow_query_log=off; select sleep(5); FLUSH SLOW LOGS; select sleep(10); set global slow_query_log=@sq_log_save;'</span><span class="w"></span>
<span class="w">    </span><span class="n">endscript</span><span class="w"></span>
<span class="w">    </span><span class="n">rotate</span><span class="w"> </span><span class="mi">150</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>More info. about each config. directive:</p>
<ul>
<li><code>size 1G</code>: Rotate a log file only if it's bigger than 1Gb</li>
<li><code>dateext</code>: archive old log files by adding a date extension using the format YYYYMMDD instead of using a number.</li>
<li><code>compress</code>: compress old log files using gzip(default compression program)<ul>
<li><code>delaycompress</code>: postpone compression of the previous log file until the next rotation cylce</li>
</ul>
</li>
<li><code>missingok</code>: if a log file is missing, don't issue an error message</li>
<li><code>rotate 20</code>: keep 20 log files before deleting old ones</li>
<li><code>notifempty</code>: don't rotate empty log files</li>
<li><code>sharedscripts</code>: run <code>prerotate</code> &amp; <code>postrotate</code> scripts only once, no matter how many logs match the wildcard pattern</li>
<li><code>nocopytruncate</code>: don't truncate the original log file in place after creating a copy</li>
<li><code>create 660 mysql mysql</code>: after rotation, create a new log file owned by mysql with permissions mode 660</li>
<li><code>postrotate</code>: script executed after rotation is done</li>
</ul>
<h2>Further Reading</h2>
<ol>
<li><a href="https://dev.mysql.com/doc/refman/5.5/en/slow-query-log.html">MySQL Slow Query Log</a></li>
<li><a href="http://linux.die.net/man/8/logrotate">logrotate man page</a></li>
</ol>
<p>This post is also available on my <a href="https://oguya.ch/posts/2016-04-13-safely-rotating-mysql-slow-logs/">personal blog</a>.</p>
    </div>
  </article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
      <li class="list-inline-item"><a href="/authors.html">Authors</a></li>
    <li class="list-inline-item"><a href="/archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="/categories.html">Categories</a></li>
      <li class="list-inline-item"><a href="/tags.html">Tags</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
  </p>
</div>    </div>
  </footer>
</body>

</html>