<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="https://nairobilug.or.ke/2016/07/using-systemd-timers-to-renew-lets-encrypt-certificates.html" />

    <title>  Nairobi LUG &mdash; Using systemd Timers to Renew Let’s Encrypt Certificates
</title>

      <link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
      <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
      <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
      <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">



    <link rel="stylesheet" href="https://nairobilug.or.ke/theme/css/style.css">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-59440070-1', 'auto');
    ga('send', 'pageview');

  </script>

    <meta name="author" content="Alan Orth">
    <meta name="description" content="Automating the Let's Encrypt TLS certificate renewal process using systemd timers on GNU/Linux is easier and more flexible than using cron.">
  <meta name="tags" contents="Let's Encrypt, systemd, Security, ">
</head>

<body>
<header class="header">
  <div class="container">
      <div class="header-image pull-left">
        <a class="nodec" href="https://nairobilug.or.ke"><img src=/images/profile.svg width="200" height="200"></a>
      </div>
    <div class="header-inner">
      <h1 class="header-name">
        <a class="nodec" href="https://nairobilug.or.ke">Nairobi LUG</a>
      </h1>
      <h3 class="header-text">A lively community of GNU/Linux enthusiasts</h3>
      <ul class="header-menu list-inline">
          <li><a class="nodec" href="http://webchat.freenode.net/?channels=nairobilug" target="_blank">IRC</a></li>
          <li><a class="nodec" href="https://groups.google.com/forum/#!forum/nairobi-gnu" target="_blank">Mailing List</a></li>
              <li class="muted">|</li>
            <li><a class="nodec" href="https://nairobilug.or.ke/2016/12/pages/about-us.html">About Us</a></li>
            <li><a class="nodec" href="https://nairobilug.or.ke/2016/12/pages/contact.html">Contact</a></li>
            <li><a class="nodec" href="https://nairobilug.or.ke/2016/12/pages/mailing-list.html">Mailing List</a></li>
            <li><a class="nodec" href="https://nairobilug.or.ke/2016/12/pages/meetups.html">Meetups</a></li>
              <li class="muted">|</li>
          <li><a class="nodec icon-github" href="https://github.com/nairobilug"></a></li>
          <li><a class="nodec icon-twitter" href="https://twitter.com/nairobilug"></a></li>
      </ul>
    </div>
  </div>
</header> <!-- /.header -->  <div class="container">
  <div class="post full-post">
    <h1 class="post-title">
      <a href="/2016/07/using-systemd-timers-to-renew-lets-encrypt-certificates.html" title="Permalink to Using systemd Timers to Renew Let’s Encrypt Certificates">Using systemd Timers to Renew Let’s Encrypt Certificates</a>
    </h1>
    <ul class="list-inline">
      <li class="post-date">
        <a class="text-muted" href="/2016/07/using-systemd-timers-to-renew-lets-encrypt-certificates.html" title="2016-07-11T14:42:00+03:00">Mon 11 July 2016</a>
      </li>
      <li class="muted">&middot;</li>
      <li class="post-category">
        <a href="https://nairobilug.or.ke/category/linux.html">Linux</a>
      </li>
        <li class="muted">&middot;</li>
        <li>
            <a href="https://nairobilug.or.ke/tag/lets-encrypt.html">Let's Encrypt</a>,             <a href="https://nairobilug.or.ke/tag/systemd.html">systemd</a>,             <a href="https://nairobilug.or.ke/tag/security.html">Security</a>        </li>
        <li class="muted">&middot;</li>
        <li>
          <address class="post-author">
            By <a href="https://nairobilug.or.ke/author/alan-orth.html">Alan Orth</a>
          </address>
        </li>
    </ul>
    <div class="post-content">
      <p>This is a quick blog post to share the systemd timers that I use to automate the renewal of my <a href="https://letsencrypt.org">Let's Encrypt</a> certificates. I prefer <a href="https://nairobilug.or.ke/2015/06/cron-systemd-timers.html">systemd timers to cron jobs</a> for task scheduling because they are more flexible and easier to debug. I assume that you know what Let's Encrypt is and that you already have some certificates. If not, I recommend that you check out <a href="https://certbot.eff.org">Certbot</a> (the official reference client) and get some.</p>
<p><a href="https://letsencrypt.org/" title="Let's Encrypt homepage"><img alt="Let's Encrypt logo" src="https://nairobilug.or.ke/images/letsencrypt-systemd-timers/lets-encrypt.png" /></a></p>
<p>Because Let's Encrypt issues <abbr title="Transport Layer Security">TLS</abbr> certificates with much <a href="https://letsencrypt.org/2015/11/09/why-90-days.html">shorter lifetimes</a> (currently ninety days) than traditional certificate authorities, they expect you to reduce the burden of the issuance and renewal processes by performing them programmatically and automating them.</p>
<h2>Check Early, Check Often</h2>
<p>Your certificates are good for ninety days, but checking them for renewal on a daily or weekly basis allows for some margin of error in case of server downtime, network interruptions, beach holidays, etc. In the future Let's Encrypt might use even shorter lifespans so it's good to get familiar with this automation now. You will need to create both the <code>service</code> and <code>timer</code> unit files below.</p>
<p><em>/etc/systemd/system/renew-letsencrypt.service</em> :</p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Renew Let&#39;s Encrypt certificates</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">oneshot</span>
<span class="c1"># check for renewal, only start/stop nginx if certs need to be renewed</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/opt/certbot-auto renew --standalone --pre-hook &quot;/bin/systemctl stop nginx&quot; --post-hook &quot;/bin/systemctl start nginx&quot;</span>
</pre></div>


<p><em>/etc/systemd/system/renew-letsencrypt.timer</em> :</p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Daily renewal of Let&#39;s Encrypt&#39;s certificates</span>

<span class="k">[Timer]</span>
<span class="c1"># once a day, at 2AM</span>
<span class="na">OnCalendar</span><span class="o">=</span><span class="s">*-*-* 02:00:00</span>
<span class="c1"># Be kind to the Let&#39;s Encrypt servers: add a random delay of 0–3600 seconds</span>
<span class="na">RandomizedDelaySec</span><span class="o">=</span><span class="s">3600</span>
<span class="na">Persistent</span><span class="o">=</span><span class="s">true</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">timers.target</span>
</pre></div>


<p>This timer runs once a day at 2AM, but each execution is delayed by a random amount of time between zero and 3600 seconds using the <code>RandomizedDelaySec</code> option.</p>
<p>Pay attention to the location of the <code>certbot-auto</code> script in the service file and adjust accordingly for your setup. Also note that I'm using the <code>standalone</code> mode of execution because the <code>nginx</code> one isn't stable yet. See the <a href="https://certbot.eff.org/docs/using.html#renewal">Certbot renewal documentation</a> for more examples.</p>
<h2>Activate and Enable the Timer</h2>
<p>Tell systemd to read the system's unit files again, and then start and enable the timer:</p>
<div class="highlight"><pre><span></span>$ sudo systemctl daemon-reload
$ sudo systemctl start renew-letsencrypt.timer
$ sudo systemctl <span class="nb">enable</span> renew-letsencrypt.timer
</pre></div>


<p>Starting the timer is necessary because otherwise it wouldn't be active until the next time you rebooted (assuming it was enabled, that is). You can verify that the timer has been started, its planned execution times, service logs, etc using the following commands:</p>
<div class="highlight"><pre><span></span>$ sudo systemctl list-timers
$ sudo journalctl -u renew-letsencrypt
$ sudo journalctl -u renew-letsencrypt --since<span class="o">=</span><span class="s2">&quot;yesterday&quot;</span>
</pre></div>


<h2>More Information</h2>
<p>See the following for more information:</p>
<ul>
<li><a href="https://wiki.archlinux.org/index.php/Systemd/Timers">systemd timers on the Arch Linux wiki</a></li>
<li><code>man systemd.timer</code></li>
<li><code>man systemd.time</code></li>
<li><code>man systemd.service</code></li>
<li><code>man journalctl</code></li>
</ul>
<p>This was <a href="https://mjanja.ch/2016/07/using-systemd-timers-to-renew-lets-encrypt-certificates/">originally posted</a> on my personal blog; re-posted here for posterity.</p>
    </div>
  </div>
  <hr class="separator">
  <div class="col-md-8 col-md-offset-2">
  <div id="disqus_thread">
    <script>
      var disqus_shortname = 'nairobilug';
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] ||
         document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>
      Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript=nairobilug">
        comments powered by Disqus.
      </a>
    </noscript>
    <a href="https://disqus.com" class="dsq-brlink">
      blog comments powered by <span class="logo-disqus">Disqus</span>
    </a>
  </div>
  </div>
  </div>
<footer class="footer">
  <div class="container">
    <p class="text-center">
      Multiple, <a href="" target="_blank"></a> unless otherwise noted.
    </p>
    <div class="text-center">
      Generated by <a href="http://getpelican.com" target="_blank">Pelican</a> with the <a href="http://github.com/nairobilug/pelican-alchemy">alchemy</a> theme.
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="https://nairobilug.or.ke/theme/js/jquery.min.js"></script>
  <script src="https://nairobilug.or.ke/theme/js/bootstrap.min.js"></script>
</body> <!-- 42 -->

</html>