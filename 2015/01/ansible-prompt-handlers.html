<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="https://nairobilug.or.ke/2015/01/ansible-prompt-handlers.html" />

    <title>  Nairobi LUG &mdash; Ansible 'Prompt' Handlers
</title>

      <link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
      <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
      <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
      <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">


      <link type="application/atom+xml" rel="alternate" href="/feed/atom.xml"  title="Nairobi LUG Atom Feed">

    <link rel="stylesheet" href="https://nairobilug.or.ke/theme/css/style.css">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-59440070-1', 'auto');
    ga('send', 'pageview');

  </script>

    <meta name="author" content="James Oguya">
    <meta name="description" content="An awesome feature in Chef that is not available in Ansible is immediate notification. Ansible has notification handlers but they are only triggered at the end of the current playbook unlike Chef's which can be triggered immediately! This blogpost describes an easier way of having immediate handlers in ansible.">
  <meta name="tags" contents="linux, ansible, tomcat, ">
</head>

<body>
<header class="header">
  <div class="container">
      <div class="header-image pull-left">
        <a class="nodec" href="https://nairobilug.or.ke"><img src=/images/profile.svg width="200" height="200"></a>
      </div>
    <div class="header-inner">
      <h1 class="header-name">
        <a class="nodec" href="https://nairobilug.or.ke">Nairobi LUG</a>
      </h1>
      <h3 class="header-text">Nairobi GNU/Linux Users Group</h3>
      <ul class="header-menu list-inline">
          <li><a class="nodec" href="https://kiwiirc.com/client/irc.freenode.net/#nairobilug" target="_blank">IRC</a></li>
          <li><a class="nodec" href="https://groups.google.com/forum/#!forum/nairobi-gnu" target="_blank">Mailing List</a></li>
              <li class="muted">|</li>
            <li><a class="nodec" href="https://nairobilug.or.ke/2013/10/pages/about-us.html">About Us</a></li>
              <li class="muted">|</li>
          <li><a class="nodec icon-github" href="https://github.com/nairobilug"></a></li>
          <li><a class="nodec icon-twitter" href="https://twitter.com/nairobilug"></a></li>
          <li><a class="nodec icon-rss" href="/feed/atom.xml"></a></li>
      </ul>
    </div>
  </div>
</header> <!-- /.header -->  <div class="container">
  <div class="post full-post">
    <h1 class="post-title">
      <a href="/2015/01/ansible-prompt-handlers.html" title="Permalink to Ansible 'Prompt' Handlers">Ansible 'Prompt' Handlers</a>
    </h1>
    <ul class="list-inline">
      <li class="post-date">
        <a class="text-muted" href="/2015/01/ansible-prompt-handlers.html" title="2015-01-02T11:00:00+03:00">Fri 02 January 2015</a>
      </li>
      <li class="muted">&middot;</li>
      <li class="post-category">
        <a href="https://nairobilug.or.ke/category/linux.html">Linux</a>
      </li>
        <li class="muted">&middot;</li>
        <li>
            <a href="https://nairobilug.or.ke/tag/linux.html">linux</a>,             <a href="https://nairobilug.or.ke/tag/ansible.html">ansible</a>,             <a href="https://nairobilug.or.ke/tag/tomcat.html">tomcat</a>        </li>
        <li class="muted">&middot;</li>
        <li>
          <address class="post-author">
            By <a href="https://nairobilug.or.ke/author/james-oguya.html">James Oguya</a>
          </address>
        </li>
    </ul>
    <div class="post-content">
      <p>An awesome feature in <a href="https://chef.io">Chef</a> that is not available in <a href="http://ansible.com">Ansible</a> is immediate notification i.e. <code>notifies :immediately</code>. Ansible has <a href="http://docs.ansible.com/playbooks_intro.html#handlers-running-operations-on-change">notification handlers</a> but they are only triggered at the end of the current playbook unlike <a href="https://docs.chef.io/resource_common.html#notifies-syntax">Chef's notifications</a> which can be triggered immediately! Moreover, you can configure Chef's notifications to be triggered at specific times e.g. at the very end of a chef-client run i.e. <code>notifies :delayed</code> or immediately i.e. <code>notifies :immediately</code>.</p>
<p>Now, why I'm going into all these boring theories? Well, when installing tomcat on Ubuntu, dpkg starts it automatically once the process is complete. But in my case, I wanted to stop tomcat7 service first, configure it, deploy its webapps &amp; finally start it. So on my ansible tasks file, after installing tomcat7 I added a notification action to call a task that stops tomcat7 service. Here's a snippet from the ansible task file:</p>
<p><em>tomcat.yml</em>:</p>
<div class="highlight"><pre><span></span><span class="x">- hosts: all</span>
<span class="x">  sudo: yes</span>
<span class="x">  tasks:</span>
<span class="x">    - name: Install tomcat7</span>
<span class="x">      apt: name=</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x"> install_recommends=no update_cache=yes  state=present</span>
<span class="x">      with_items:</span>
<span class="x">        - tomcat7</span>
<span class="x">        - tomcat7-admin</span>
<span class="x">      notify:</span>
<span class="x">        - Temporarily stop tomcat7</span>

<span class="x">  handlers:</span>
<span class="x">      - name: Temporarily stop tomcat7</span>
<span class="x">      service: name=tomcat7 state=stopped</span>
</pre></div>


<p>OK so the task file looks great, but did it work ? Unfortunately, no! Ansible notifications trigger tasks in handlers section to run only at the end of a playbook. So I had to come up with a quick fix for this issue.</p>
<h3>'Prompt' Handlers</h3>
<p>My quick fix involved registering a variable in the task that installs tomcat packages i.e. <code>register: tomcat_installed</code>, then the next task to stop tomcat service would be executed only if the registered variable has changed i.e. if tomcat7 has been installed - <code>when: tomcat_installed|changed</code>. Basically, ansible notifications use a similar concept to this.</p>
<p>Here's a snippet from the playbook showing the quick fix:</p>
<p><em>tomcat.yml</em>:</p>
<div class="highlight"><pre><span></span><span class="x">- hosts: all</span>
<span class="x">  sudo: yes</span>
<span class="x">  tasks:</span>
<span class="x">      - name: Install tomcat7</span>
<span class="x">        apt: name=</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x"> install_recommends=no update_cache=yes state=present</span>
<span class="x">        with_items:</span>
<span class="x">          - tomcat7</span>
<span class="x">          - tomcat7-admin</span>
<span class="x">        register: tomcat_installed</span>

<span class="x">      - name: Temporarily stop tomcat7</span>
<span class="x">        service: name=tomcat7 state=stopped</span>
<span class="x">        when: tomcat_installed|changed</span>
</pre></div>


<p>As you can see from the snippet, I've not used a handler. Yes that's right, inorder to achieve the effect of an 'immediate' handler, I moved the task that stops tomcat7 service from the handler section to the tasks section.</p>
<h3>Conclusion</h3>
<p>Though I'm sure there are better solutions out there, I think the concept behind my quick fix can be useful in tackling other ansible-related issues.</p>
    </div>
  </div>
  <hr class="separator">
  <div class="col-md-8 col-md-offset-2">
  <div id="disqus_thread">
    <script>
      var disqus_shortname = 'nairobilug';
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] ||
         document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>
      Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript=nairobilug">
        comments powered by Disqus.
      </a>
    </noscript>
    <a href="https://disqus.com" class="dsq-brlink">
      blog comments powered by <span class="logo-disqus">Disqus</span>
    </a>
  </div>
  </div>
  </div>
<footer class="footer">
  <div class="container">
    <p class="text-center">
      Multiple, <a href="" target="_blank"></a> unless otherwise noted.
    </p>
    <div class="text-center">
      Generated by <a href="http://getpelican.com" target="_blank">Pelican</a> with the <a href="http://github.com/nairobilug/pelican-alchemy">alchemy</a> theme.
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="https://nairobilug.or.ke/theme/js/jquery.min.js"></script>
  <script src="https://nairobilug.or.ke/theme/js/bootstrap.min.js"></script>
</body> <!-- 42 -->

</html>