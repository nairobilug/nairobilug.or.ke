<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>  Ansible 'Prompt' Handlers | Nairobi GNU/Linux Users Group
</title>
  <link rel="canonical" href="/2015/01/ansible-prompt-handlers.html">

    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#333333">

  <link rel="stylesheet" href="/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="/theme/css/pygments/monokai.min.css">
  <link rel="stylesheet" href="/theme/css/theme.css">

  
  <meta name="description" content="An awesome feature in Chef that is not available in Ansible is immediate notification. Ansible has notification handlers but they are only triggered at the end of the current playbook unlike Chef's which can be triggered immediately! This blogpost describes an easier way of having immediate handlers in ansible.">


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
    <div class="col-sm-4">
      <a href="/">
        <img class="img-fluid rounded" src=/images/profile.png alt="Nairobi GNU/Linux Users Group">
      </a>
    </div>
  <div class="col-sm-8">
    <h1 class="title"><a href="/">Nairobi GNU/Linux Users Group</a></h1>
      <p class="text-muted">A lively community of GNU/Linux enthusiasts</p>
      <ul class="list-inline">
          <li class="list-inline-item"><a href="https://web.libera.chat/?channels=#nairobilug" target="_blank">IRC</a></li>
              <li class="list-inline-item text-muted">|</li>
            <li class="list-inline-item"><a href="/pages/about-us.html">About Us</a></li>
            <li class="list-inline-item"><a href="/pages/contact.html">Contact</a></li>
            <li class="list-inline-item"><a href="/pages/mailing-list.html">Mailing List</a></li>
            <li class="list-inline-item"><a href="/pages/meetups.html">Meetups</a></li>
            <li class="list-inline-item"><a href="/pages/software.html">Software</a></li>
            <li class=" list-inline-item text-muted">|</li>
          <li class="list-inline-item"><a class="fa fa-github" href="https://github.com/nairobilug" target="_blank"></a></li>
          <li class="list-inline-item"><a class="fa fa-twitter" href="https://twitter.com/nairobilug" target="_blank"></a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  Ansible 'Prompt' Handlers
</h1>
      <hr>
  <article class="article">
    <header>
      <ul class="list-inline">
        <li class="list-inline-item text-muted" title="2015-01-02T11:00:00+03:00">
          <i class="fa fa-clock-o"></i>
          Fri 02 January 2015
        </li>
        <li class="list-inline-item">
          <i class="fa fa-folder-open-o"></i>
          <a href="/category/linux.html">Linux</a>
        </li>
          <li class="list-inline-item">
            <i class="fa fa-user-o"></i>
              <a href="/author/james-oguya.html">James Oguya</a>          </li>
          <li class="list-inline-item">
            <i class="fa fa-files-o"></i>
              <a href="/tag/linux.html">#linux</a>,               <a href="/tag/ansible.html">#ansible</a>,               <a href="/tag/tomcat.html">#tomcat</a>          </li>
      </ul>
    </header>
    <div class="content">
      <p>An awesome feature in <a href="https://chef.io">Chef</a> that is not available in <a href="http://ansible.com">Ansible</a> is immediate notification i.e. <code>notifies :immediately</code>. Ansible has <a href="http://docs.ansible.com/playbooks_intro.html#handlers-running-operations-on-change">notification handlers</a> but they are only triggered at the end of the current playbook unlike <a href="https://docs.chef.io/resource_common.html#notifies-syntax">Chef's notifications</a> which can be triggered immediately! Moreover, you can configure Chef's notifications to be triggered at specific times e.g. at the very end of a chef-client run i.e. <code>notifies :delayed</code> or immediately i.e. <code>notifies :immediately</code>.</p>
<p>Now, why I'm going into all these boring theories? Well, when installing tomcat on Ubuntu, dpkg starts it automatically once the process is complete. But in my case, I wanted to stop tomcat7 service first, configure it, deploy its webapps &amp; finally start it. So on my ansible tasks file, after installing tomcat7 I added a notification action to call a task that stops tomcat7 service. Here's a snippet from the ansible task file:</p>
<p><em>tomcat.yml</em>:</p>
<div class="highlight"><pre><span></span><code><span class="x">- hosts: all</span>
<span class="x">  sudo: yes</span>
<span class="x">  tasks:</span>
<span class="x">    - name: Install tomcat7</span>
<span class="x">      apt: name=</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x"> install_recommends=no update_cache=yes  state=present</span>
<span class="x">      with_items:</span>
<span class="x">        - tomcat7</span>
<span class="x">        - tomcat7-admin</span>
<span class="x">      notify:</span>
<span class="x">        - Temporarily stop tomcat7</span>

<span class="x">  handlers:</span>
<span class="x">      - name: Temporarily stop tomcat7</span>
<span class="x">      service: name=tomcat7 state=stopped</span>
</code></pre></div>
<p>OK so the task file looks great, but did it work ? Unfortunately, no! Ansible notifications trigger tasks in handlers section to run only at the end of a playbook. So I had to come up with a quick fix for this issue.</p>
<h3>'Prompt' Handlers</h3>
<p>My quick fix involved registering a variable in the task that installs tomcat packages i.e. <code>register: tomcat_installed</code>, then the next task to stop tomcat service would be executed only if the registered variable has changed i.e. if tomcat7 has been installed - <code>when: tomcat_installed|changed</code>. Basically, ansible notifications use a similar concept to this.</p>
<p>Here's a snippet from the playbook showing the quick fix:</p>
<p><em>tomcat.yml</em>:</p>
<div class="highlight"><pre><span></span><code><span class="x">- hosts: all</span>
<span class="x">  sudo: yes</span>
<span class="x">  tasks:</span>
<span class="x">      - name: Install tomcat7</span>
<span class="x">        apt: name=</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x"> install_recommends=no update_cache=yes state=present</span>
<span class="x">        with_items:</span>
<span class="x">          - tomcat7</span>
<span class="x">          - tomcat7-admin</span>
<span class="x">        register: tomcat_installed</span>

<span class="x">      - name: Temporarily stop tomcat7</span>
<span class="x">        service: name=tomcat7 state=stopped</span>
<span class="x">        when: tomcat_installed|changed</span>
</code></pre></div>
<p>As you can see from the snippet, I've not used a handler. Yes that's right, inorder to achieve the effect of an 'immediate' handler, I moved the task that stops tomcat7 service from the handler section to the tasks section.</p>
<h3>Conclusion</h3>
<p>Though I'm sure there are better solutions out there, I think the concept behind my quick fix can be useful in tackling other ansible-related issues.</p>
    </div>
  </article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
      <li class="list-inline-item"><a href="/authors.html">Authors</a></li>
    <li class="list-inline-item"><a href="/archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="/categories.html">Categories</a></li>
      <li class="list-inline-item"><a href="/tags.html">Tags</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
  </p>
</div>    </div>
  </footer>
</body>

</html>