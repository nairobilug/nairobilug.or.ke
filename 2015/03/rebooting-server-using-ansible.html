<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="https://nairobilug.or.ke/2015/03/rebooting-server-using-ansible.html" />

    <title>  Nairobi LUG &mdash; Rebooting Server(s) Using Ansible
</title>

      <link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
      <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
      <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
      <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">


      <link type="application/atom+xml" rel="alternate" href="/feed/atom.xml"  title="Nairobi LUG Atom Feed">

    <link rel="stylesheet" href="https://nairobilug.or.ke/theme/css/style.css">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-59440070-1', 'auto');
    ga('send', 'pageview');

  </script>

    <meta name="author" content="James Oguya">
    <meta name="description" content="Ansible provides useful tools which we can use to for various purposes. In this blogpost, we'll talk about rebooting servers using ansible & pausing the playbook by waiting for a given amount of time for a given service on a given port to start.">
  <meta name="tags" contents="linux, ansible, ">
</head>

<body>
<header class="header">
  <div class="container">
      <div class="header-image pull-left">
        <a class="nodec" href="https://nairobilug.or.ke"><img src=/images/profile.svg width="200" height="200"></a>
      </div>
    <div class="header-inner">
      <h1 class="header-name">
        <a class="nodec" href="https://nairobilug.or.ke">Nairobi LUG</a>
      </h1>
      <h3 class="header-text">Nairobi GNU/Linux Users Group</h3>
      <ul class="header-menu list-inline">
          <li><a class="nodec" href="https://kiwiirc.com/client/irc.freenode.net/#nairobilug" target="_blank">IRC</a></li>
          <li><a class="nodec" href="https://groups.google.com/forum/#!forum/nairobi-gnu" target="_blank">Mailing List</a></li>
              <li class="muted">|</li>
            <li><a class="nodec" href="https://nairobilug.or.ke/2013/10/pages/about-us.html">About Us</a></li>
              <li class="muted">|</li>
          <li><a class="nodec icon-github" href="https://github.com/nairobilug"></a></li>
          <li><a class="nodec icon-twitter" href="https://twitter.com/nairobilug"></a></li>
          <li><a class="nodec icon-rss" href="/feed/atom.xml"></a></li>
      </ul>
    </div>
  </div>
</header> <!-- /.header -->  <div class="container">
  <div class="post full-post">
    <h1 class="post-title">
      <a href="/2015/03/rebooting-server-using-ansible.html" title="Permalink to Rebooting Server(s) Using Ansible">Rebooting Server(s) Using Ansible</a>
    </h1>
    <ul class="list-inline">
      <li class="post-date">
        <a class="text-muted" href="/2015/03/rebooting-server-using-ansible.html" title="2015-03-03T12:35:00+03:00">Tue 03 March 2015</a>
      </li>
      <li class="muted">&middot;</li>
      <li class="post-category">
        <a href="https://nairobilug.or.ke/category/linux.html">Linux</a>
      </li>
        <li class="muted">&middot;</li>
        <li>
            <a href="https://nairobilug.or.ke/tag/linux.html">linux</a>,             <a href="https://nairobilug.or.ke/tag/ansible.html">ansible</a>        </li>
        <li class="muted">&middot;</li>
        <li>
          <address class="post-author">
            By <a href="https://nairobilug.or.ke/author/james-oguya.html">James Oguya</a>
          </address>
        </li>
    </ul>
    <div class="post-content">
      <p>Of late, I've seen a lot of guys on <code>#ansible</code> irc channel &amp; google groups asking questions about rebooting servers/nodes &amp; temporarily pausing the playbook for a given amount of time before continuing with the execution of the playbook. In some cases, you'd want to set some kernel parameters which take effect at boot time or perform major upgrades which might require a reboot before configuring the server/node.</p>
<p>Using ansible's <code>wait_for</code> module<a href="http://docs.ansible.com/wait_for_module.html"><sup>[1]</sup></a>, we can temporarily stop running the playbook while we wait for the server to finish rebooting or for a service to start &amp; bind to a port. We can also use the same module to wait for a port to become available which can be useful in situations where services are not immediately available after their <code>init</code> scripts finish running - as is the case with Java application server e.g. Tomcat.</p>
<h3>Gettin' Started</h3>
<p>Basically, we can break our problem into 4 sections for easier conceptualization:</p>
<ul>
<li>
<p>Section 1: <strong>Pre-reboot</strong>: Run your pre-reboot task, it can be performing major upgrades and/or performing some configuration which only take effect at boot time. For example - upgrade all packages using <code>yum</code> module<a href="http://docs.ansible.com/yum_module.html"><sup>[2]</sup></a></p>
<div class="highlight"><pre><span></span>- name: upgrade all packages
  yum: name=* state=latest
</pre></div>


</li>
<li>
<p>Section 2: <strong>Reboot</strong>: In this stage we'll use the <code>command</code> module<a href="http://docs.ansible.com/command_module.html"><sup>[3]</sup></a> to reboot the remote machine/server by running the <code>reboot</code> command  - nothing fancy - you can also use <code>shutdown --reboot</code>.</p>
<div class="highlight"><pre><span></span>- name: reboot server
  command: /sbin/reboot
</pre></div>


</li>
<li>
<p>Section 3: <strong>Pause the playbook</strong>: We'll use the <code>wait_for</code> module to wait for 300 seconds for port 22 to become available before resuming the playbook. I'm using port 22 because most servers run openssh-server on port 22 &amp; if we were to telnet to that port we'd probably see something like :<code>SSH-2.0-OpenSSH_6.6.1</code>, so we can use regex to check whether the output matches "OpenSSH". I'm also using a <code>timeout</code> value of 300 seconds because most physical servers take 3 - 5 minutes to finish rebooting due to hardware checks e.t.c. but you can use any value that suites you. For example: - wait for 300 seconds for port 22 to become available &amp; contain <code>OpenSSH</code></p>
<div class="highlight"><pre><span></span>- name: wait for the server to finish rebooting
  local_action: wait_for host=&quot;web01&quot; search_regex=OpenSSH port=22 timeout=300
</pre></div>


</li>
<li>
<p>Section 4: <strong>Resume the playbook</strong>: After we've got a response from port 22, we can resume running the playbook. This step can be optional depending on your needs.</p>
</li>
</ul>
<h3>Puttin' It All Together</h3>
<ul>
<li>We can merge all the above sections into one playbook as shown below:<div class="highlight"><pre><span></span><span class="x">- hosts: all</span>
<span class="x">  sudo: yes</span>
<span class="x">  tasks:</span>
<span class="x">    - name: Upgrade all packages in RedHat-based machines</span>
<span class="x">      when: ansible_os_family == &quot;Redhat&quot;</span>
<span class="x">      yum: name=* state=latest</span>

<span class="x">    - name: Upgrade all packages in Debian-based machines</span>
<span class="x">      when: ansible_os_family == &quot;Debian&quot;</span>
<span class="x">      apt: upgrade=dist update_cache=yes</span>

<span class="x">    - name: Reboot server</span>
<span class="x">      command: /sbin/reboot</span>

<span class="x">    - name: Wait for the server to finish rebooting</span>
<span class="x">      sudo: no</span>
<span class="x">      local_action: wait_for host=&quot;</span><span class="cp">{{</span> <span class="nv">inventory_hostname</span> <span class="cp">}}</span><span class="x">&quot; search_regex=OpenSSH port=22 timeout=300</span>
</pre></div>


</li>
</ul>
<h3>Stuff to Note</h3>
<ul>
<li>I know you might be wondering why we didn't use handlers. Well, <code>notify</code> tasks<a href="http://docs.ansible.com/playbooks_intro.html#handlers-running-operations-on-change"><sup>[4]</sup></a> are only executed at the end of the playbook regardless of their location in the playbook - remember we're interested in rebooting the server &amp; waiting for a given amount of time for the server to finish rebooting.</li>
<li><code>inventory_hostname</code> variable<a href="http://docs.ansible.com/playbooks_variables.html#magic-variables-and-how-to-access-information-about-other-hosts"><sup>[5]</sup></a> is the name of the remote server as stated in the ansible hosts file</li>
<li><code>local_action</code> directive<a href="http://docs.ansible.com/glossary.html#local-action"><sup>[6]</sup></a> runs the given step on the local machine, for example, it would run the <code>wait_for</code> task on your local machine.</li>
<li><code>yum</code> module only works on RedHat based OS e.g. Fedora, CentOS &amp; RHEL - and so we'll also use the <code>apt</code> module for Debian based OS e.g. Ubuntu, Debian e.t.c.</li>
</ul>
<h3>Links</h3>
<ol>
<li><a href="http://docs.ansible.com/wait_for_module.html">Ansible wait_for module</a></li>
<li><a href="http://docs.ansible.com/command_module.html">Ansible command module</a></li>
<li><a href="http://docs.ansible.com/yum_module.html">Ansible yum module</a></li>
<li><a href="http://docs.ansible.com/playbooks_intro.html#handlers-running-operations-on-change">Ansible Handlers: Running operations on change</a></li>
<li><a href="http://docs.ansible.com/playbooks_variables.html#magic-variables-and-how-to-access-information-about-other-hosts">Playbook built-in variables</a></li>
<li><a href="http://docs.ansible.com/glossary.html#local-action">Ansible local_action directives</a></li>
</ol>
    </div>
  </div>
  <hr class="separator">
  <div class="col-md-8 col-md-offset-2">
  <div id="disqus_thread">
    <script>
      var disqus_shortname = 'nairobilug';
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] ||
         document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>
      Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript=nairobilug">
        comments powered by Disqus.
      </a>
    </noscript>
    <a href="https://disqus.com" class="dsq-brlink">
      blog comments powered by <span class="logo-disqus">Disqus</span>
    </a>
  </div>
  </div>
  </div>
<footer class="footer">
  <div class="container">
    <p class="text-center">
      Multiple, <a href="" target="_blank"></a> unless otherwise noted.
    </p>
    <div class="text-center">
      Generated by <a href="http://getpelican.com" target="_blank">Pelican</a> with the <a href="http://github.com/nairobilug/pelican-alchemy">alchemy</a> theme.
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="https://nairobilug.or.ke/theme/js/jquery.min.js"></script>
  <script src="https://nairobilug.or.ke/theme/js/bootstrap.min.js"></script>
</body> <!-- 42 -->

</html>